<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tideline PAY — Get Started</title>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --ocean-deep: #0a1628;
    --ocean-bright: #1a56db;
    --ocean-light: #3b82f6;
    --gold: #d4a843;
    --text: #f0f4f8;
    --text-muted: #8bacc8;
    --success: #22c55e;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'DM Sans', sans-serif; background: var(--ocean-deep); color: var(--text); min-height: 100vh; overflow-x: hidden; }
  .ocean-bg { position: fixed; inset: 0; z-index: 0; background: radial-gradient(ellipse 80% 50% at 20% 80%, rgba(26,86,219,0.15) 0%, transparent 60%), radial-gradient(ellipse 60% 40% at 80% 20%, rgba(59,130,246,0.08) 0%, transparent 50%), linear-gradient(180deg, #0a1628 0%, #0d1f3c 50%, #0a1628 100%); }
  .wave { position: fixed; bottom: 0; left: 0; width: 200%; height: 120px; opacity: 0.06; animation: wave 8s ease-in-out infinite; }
  .wave-2 { animation: wave 12s ease-in-out infinite reverse; opacity: 0.04; bottom: 20px; }
  @keyframes wave { 0%,100% { transform: translateX(0) translateY(0); } 50% { transform: translateX(-25%) translateY(-15px); } }
  .grid-overlay { position: fixed; inset: 0; z-index: 0; background-image: linear-gradient(rgba(26,86,219,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(26,86,219,0.03) 1px, transparent 1px); background-size: 60px 60px; }
  .container { position: relative; z-index: 10; max-width: 560px; margin: 0 auto; padding: 80px 24px 80px; }
  .header { text-align: center; margin-bottom: 56px; animation: fadeUp 0.6s ease both; }
  .logo { display: inline-flex; align-items: center; gap: 10px; margin-bottom: 32px; }
  .logo-mark { width: 36px; height: 36px; background: linear-gradient(135deg, var(--ocean-bright), var(--ocean-light)); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
  .logo-text { font-family: 'Instrument Serif', serif; font-size: 22px; color: var(--text); letter-spacing: -0.02em; }
  .logo-text span { color: var(--ocean-light); }
  h1 { font-family: 'Instrument Serif', serif; font-size: clamp(36px, 6vw, 52px); font-weight: 400; line-height: 1.1; letter-spacing: -0.03em; margin-bottom: 16px; }
  h1 em { font-style: italic; color: var(--ocean-light); }
  .subtitle { font-size: 16px; color: var(--text-muted); line-height: 1.6; font-weight: 300; max-width: 400px; margin: 0 auto; }
  .steps { display: flex; align-items: center; justify-content: center; margin-bottom: 48px; animation: fadeUp 0.6s 0.1s ease both; }
  .step { display: flex; flex-direction: column; align-items: center; gap: 6px; }
  .step-dot { width: 32px; height: 32px; border-radius: 50%; border: 2px solid rgba(139,172,200,0.3); display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 600; color: var(--text-muted); transition: all 0.3s ease; }
  .step.active .step-dot { background: var(--ocean-bright); border-color: var(--ocean-bright); color: white; box-shadow: 0 0 20px rgba(26,86,219,0.4); }
  .step.completed .step-dot { background: var(--success); border-color: var(--success); color: white; }
  .step-label { font-size: 11px; color: var(--text-muted); font-weight: 500; letter-spacing: 0.04em; text-transform: uppercase; }
  .step.active .step-label { color: var(--ocean-light); }
  .step.completed .step-label { color: var(--success); }
  .step-line { width: 60px; height: 2px; background: rgba(139,172,200,0.15); margin: 0 8px 20px; transition: background 0.3s ease; }
  .step-line.done { background: var(--success); }
  .card { background: rgba(13,37,69,0.6); border: 1px solid rgba(26,86,219,0.2); border-radius: 20px; padding: 40px; backdrop-filter: blur(20px); animation: fadeUp 0.6s 0.2s ease both; box-shadow: 0 4px 6px rgba(0,0,0,0.3), 0 20px 60px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.05); }
  .step-panel { display: none; }
  .step-panel.active { display: block; }
  .card-title { font-family: 'Instrument Serif', serif; font-size: 24px; font-weight: 400; margin-bottom: 6px; }
  .card-desc { font-size: 14px; color: var(--text-muted); margin-bottom: 32px; line-height: 1.5; }
  .field { margin-bottom: 20px; }
  label { display: block; font-size: 13px; font-weight: 500; color: var(--text-muted); letter-spacing: 0.04em; text-transform: uppercase; margin-bottom: 8px; }
  input { width: 100%; background: rgba(10,22,40,0.8); border: 1px solid rgba(26,86,219,0.25); border-radius: 10px; padding: 14px 16px; font-size: 15px; font-family: 'DM Sans', sans-serif; color: var(--text); outline: none; transition: all 0.2s ease; }
  input::placeholder { color: rgba(139,172,200,0.4); }
  input:focus { border-color: var(--ocean-bright); background: rgba(26,86,219,0.08); box-shadow: 0 0 0 3px rgba(26,86,219,0.15); }
  input.error { border-color: #ef4444; }
  .field-hint { font-size: 12px; color: var(--text-muted); margin-top: 6px; opacity: 0.7; }
  .pricing-pill { display: inline-flex; align-items: center; gap: 8px; background: rgba(212,168,67,0.1); border: 1px solid rgba(212,168,67,0.3); border-radius: 100px; padding: 8px 16px; margin-bottom: 28px; font-size: 13px; color: var(--gold); font-weight: 500; }
  .pricing-pill .price { font-family: 'Instrument Serif', serif; font-size: 18px; }
  .stripe-connect-btn { width: 100%; background: #635bff; border: none; border-radius: 10px; padding: 16px; font-size: 15px; font-family: 'DM Sans', sans-serif; font-weight: 600; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s ease; margin-bottom: 12px; }
  .stripe-connect-btn:hover { background: #4f46e5; transform: translateY(-1px); box-shadow: 0 8px 25px rgba(99,91,255,0.4); }
  .connected-badge { display: none; align-items: center; gap: 10px; background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); border-radius: 10px; padding: 14px 16px; font-size: 14px; color: var(--success); font-weight: 500; margin-bottom: 12px; }
  .connected-badge.show { display: flex; }
  .btn-primary { width: 100%; background: linear-gradient(135deg, var(--ocean-bright), var(--ocean-light)); border: none; border-radius: 10px; padding: 16px; font-size: 15px; font-family: 'DM Sans', sans-serif; font-weight: 600; color: white; cursor: pointer; transition: all 0.2s ease; position: relative; overflow: hidden; }
  .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 8px 25px rgba(26,86,219,0.4); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
  .btn-secondary { width: 100%; background: transparent; border: 1px solid rgba(26,86,219,0.3); border-radius: 10px; padding: 14px; font-size: 14px; font-family: 'DM Sans', sans-serif; font-weight: 500; color: var(--text-muted); cursor: pointer; transition: all 0.2s ease; margin-top: 10px; }
  .btn-secondary:hover { border-color: var(--ocean-bright); color: var(--text); }
  .benefits { list-style: none; margin-bottom: 28px; }
  .benefits li { display: flex; align-items: flex-start; gap: 10px; font-size: 14px; color: var(--text-muted); padding: 6px 0; line-height: 1.5; }
  .benefits li .icon { width: 18px; height: 18px; background: rgba(34,197,94,0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 1px; font-size: 10px; }
  .error-msg { font-size: 12px; color: #ef4444; margin-top: 6px; display: none; }
  .error-msg.show { display: block; }
  .error-box { font-size: 13px; color: #ef4444; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); border-radius: 8px; padding: 10px 14px; margin-bottom: 12px; display: none; }
  .spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.7s linear infinite; display: none; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .phone-number-preview { font-size: 13px; color: var(--ocean-light); margin-top: 6px; font-weight: 500; display: none; }
  .success-card { text-align: center; padding: 20px 0; }
  .success-icon { width: 72px; height: 72px; background: rgba(34,197,94,0.1); border: 2px solid rgba(34,197,94,0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; margin: 0 auto 24px; animation: popIn 0.4s cubic-bezier(0.175,0.885,0.32,1.275) both; }
  @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  .success-title { font-family: 'Instrument Serif', serif; font-size: 32px; margin-bottom: 12px; }
  .success-desc { font-size: 15px; color: var(--text-muted); line-height: 1.6; max-width: 360px; margin: 0 auto 32px; }
  .sms-demo { background: rgba(10,22,40,0.8); border: 1px solid rgba(26,86,219,0.2); border-radius: 12px; padding: 20px; text-align: left; margin-bottom: 24px; }
  .sms-demo-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 12px; }
  .sms-bubble { background: var(--ocean-bright); border-radius: 16px 16px 4px 16px; padding: 10px 14px; font-size: 14px; display: inline-block; margin-bottom: 8px; max-width: 240px; }
  .sms-reply { background: rgba(255,255,255,0.07); border-radius: 16px 16px 16px 4px; padding: 10px 14px; font-size: 14px; display: inline-block; max-width: 280px; float: right; clear: both; color: var(--text-muted); }
  .clearfix::after { content: ''; display: table; clear: both; }
  .secure-note { display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 12px; color: var(--text-muted); opacity: 0.6; margin-top: 20px; }
  @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  @media (max-width: 480px) { .card { padding: 28px 20px; } .container { padding: 40px 16px 60px; } .step-line { width: 36px; } }
</style>
</head>
<body>

<div style="position:fixed;top:0;left:0;right:0;z-index:1000;padding:12px 28px;display:flex;justify-content:space-between;align-items:center;background:rgba(10,22,40,0.9);backdrop-filter:blur(12px);border-bottom:1px solid rgba(26,86,219,0.15);">
  <a href="/home/" style="font-family:'Instrument Serif',serif;color:#f0f4f8;text-decoration:none;font-size:17px;display:flex;align-items:center;gap:8px;">⚓ Tideline Technologies</a>
  <div style="display:flex;gap:24px;align-items:center;">
    <a href="/tideline/" style="color:#8bacc8;text-decoration:none;font-size:13px;font-weight:500;">Marinas</a>
    <a href="/privacy/" style="color:#8bacc8;text-decoration:none;font-size:13px;font-weight:500;">Privacy</a>
    <a href="/terms/" style="color:#8bacc8;text-decoration:none;font-size:13px;font-weight:500;">Terms</a>
  </div>
</div>

<div class="ocean-bg"></div>
<div class="grid-overlay"></div>
<svg class="wave" viewBox="0 0 1440 120" preserveAspectRatio="none"><path d="M0,60 C240,100 480,20 720,60 C960,100 1200,20 1440,60 L1440,120 L0,120 Z" fill="#1a56db"/></svg>
<svg class="wave wave-2" viewBox="0 0 1440 120" preserveAspectRatio="none"><path d="M0,40 C360,80 720,0 1080,40 C1260,60 1380,30 1440,40 L1440,120 L0,120 Z" fill="#3b82f6"/></svg>

<div class="container">
  <div class="header">
    <div class="logo">
      <div class="logo-mark">⚓</div>
      <div class="logo-text">Tideline <span>PAY</span></div>
    </div>
    <h1>Send payment links<br>by <em>text message</em></h1>
    <p class="subtitle">Stop chasing payments. Send a text. Get paid.</p>
  </div>

  <div class="steps" id="stepsIndicator">
    <div class="step active" id="step-indicator-1"><div class="step-dot">1</div><div class="step-label">Your Info</div></div>
    <div class="step-line" id="line-1-2"></div>
    <div class="step" id="step-indicator-2"><div class="step-dot">2</div><div class="step-label">Stripe</div></div>
    <div class="step-line" id="line-2-3"></div>
    <div class="step" id="step-indicator-3"><div class="step-dot">3</div><div class="step-label">Subscribe</div></div>
  </div>

  <div class="card">

    <!-- Step 1 -->
    <div class="step-panel active" id="panel-1">
      <div class="card-title">Tell us about your business</div>
      <div class="card-desc">This is how we identify you when you text PAY.</div>
      <div class="field">
        <label>Business Name</label>
        <input type="text" id="businessName" placeholder="e.g. Sunrise Auto" autocomplete="organization">
        <div class="error-msg" id="err-name">Please enter your business name</div>
      </div>
      <div class="field">
        <label>Your Mobile Number</label>
        <input type="tel" id="businessPhone" placeholder="(860) 555-0100" autocomplete="tel">
        <div class="field-hint">The number you'll text PAY from</div>
        <div class="phone-number-preview" id="phonePreview"></div>
        <div class="error-msg" id="err-phone">Please enter a valid 10-digit US number</div>
      </div>
      <div class="field">
        <label>Your Email</label>
        <input type="email" id="email" placeholder="you@yourbusiness.com" autocomplete="email">
        <div class="error-msg" id="err-email">Please enter a valid email</div>
      </div>
      <button class="btn-primary" onclick="goToStep2()">Continue →</button>
    </div>

    <!-- Step 2 -->
    <div class="step-panel" id="panel-2">
      <div class="card-title">Connect your Stripe account</div>
      <div class="card-desc">Payment links go directly into your Stripe. We never touch your money.</div>
      <ul class="benefits">
        <li><div class="icon">✓</div>Customers pay via secure Stripe checkout</li>
        <li><div class="icon">✓</div>Funds deposit directly to your bank</li>
        <li><div class="icon">✓</div>We never have access to your payments</li>
        <li><div class="icon">✓</div>Works with your existing Stripe account</li>
      </ul>
      <div class="connected-badge" id="connectedBadge"><span>✓</span> Stripe connected successfully</div>
      <div class="error-box" id="stripeErrorBox"></div>
      <button class="stripe-connect-btn" id="stripeConnectBtn" onclick="connectStripe()">
        <svg width="20" height="20" viewBox="0 0 32 32" fill="none"><path d="M13.333 10.667C13.333 9.196 14.529 8 16 8s2.667 1.196 2.667 2.667c0 1.07-.63 2-1.556 2.456v7.544h-2.222v-7.544c-.926-.456-1.556-1.386-1.556-2.456z" fill="white"/><path fill-rule="evenodd" clip-rule="evenodd" d="M16 2.667C8.636 2.667 2.667 8.636 2.667 16S8.636 29.333 16 29.333 29.333 23.364 29.333 16 23.364 2.667 16 2.667zM0 16C0 7.163 7.163 0 16 0s16 7.163 16 16-7.163 16-16 16S0 24.837 0 16z" fill="white" opacity="0.4"/></svg>
        Connect with Stripe
      </button>
      <button class="btn-primary" id="continueToPayBtn" onclick="goToStep3()" disabled>Continue to subscription →</button>
      <button class="btn-secondary" onclick="goToStep1()">← Back</button>
    </div>

    <!-- Step 3 -->
    <div class="step-panel" id="panel-3">
      <div class="card-title">Start your subscription</div>
      <div class="card-desc">Unlimited PAY messages. Cancel anytime.</div>
      <div class="pricing-pill"><span class="price">$24</span><span>/ month · cancel anytime</span></div>
      <ul class="benefits">
        <li><div class="icon">✓</div>Unlimited payment links via SMS</li>
        <li><div class="icon">✓</div>Text PAY [number] [amount] — that's it</li>
        <li><div class="icon">✓</div>Customers get Stripe checkout instantly</li>
        <li><div class="icon">✓</div>Live in 5 minutes after signup</li>
      </ul>
      <div class="error-box" id="checkoutErrorBox"></div>
      <button class="btn-primary" id="subscribeBtn" onclick="handleSubscribe()">
        <span id="subscribeBtnText">Pay $24/month with Stripe →</span>
        <div class="spinner" id="subscribeSpinner"></div>
      </button>
      <button class="btn-secondary" onclick="goToStep2()">← Back</button>
      <div class="secure-note">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
        Secured by Stripe · 256-bit encryption
      </div>
    </div>

    <!-- Success -->
    <div class="step-panel" id="panel-success">
      <div class="success-card">
        <div class="success-icon">⚓</div>
        <div class="success-title">You're live!</div>
        <div class="success-desc" id="successDesc">Your account is active. Text your Tideline number to send your first payment link.</div>
        <div class="sms-demo">
          <div class="sms-demo-label">Try it now:</div>
          <div class="sms-bubble">PAY 6105551234 150.00</div>
          <div class="clearfix"></div><br>
          <div class="sms-reply">✅ Payment link for $150.00 sent to +16105551234</div>
          <div class="clearfix"></div>
        </div>
        <div class="secure-note" style="justify-content:center; opacity:0.5; margin-top:0;">Questions? Reply HELP to your Tideline number anytime</div>
      </div>
    </div>

  </div>
</div>

<script>
// ── State ────────────────────────────────────────────────────────────────────
var state = {
  businessName:    '',
  businessPhone:   '',
  email:           '',
  stripeConnected: false,
  stripeAccountId: '',
  accessToken:     ''   // connected account's access token — passed to checkout metadata
};

// ── Config ───────────────────────────────────────────────────────────────────
var CONFIG = {
  STRIPE_CLIENT_ID: 'ca_U1MduH8IWUEokZbzy6lz4O4S7RsDyTtB',
  STRIPE_PRICE_ID:  'price_1T3UNQAfYhUXAsMqgmHEFz6k',
  BACKEND_URL:      'https://tideline-pay-3364.twil.io/backend',
  TIDELINE_NUMBER:  '+1 (860) 983-5640'
};

// ── Helpers ───────────────────────────────────────────────────────────────────
function toE164(raw) {
  var d = raw.replace(/\D/g, '');
  if (d.length === 10) return '+1' + d;
  if (d.length === 11 && d[0] === '1') return '+' + d;
  return '';
}

function safeParseJSON(text) {
  var data;
  try {
    data = JSON.parse(text);
    if (typeof data === 'string') data = JSON.parse(data);
  } catch(e) { data = { raw: text }; }
  return data;
}

function updateSteps(step) {
  [1,2,3].forEach(function(i) {
    var el = document.getElementById('step-indicator-' + i);
    el.classList.remove('active','completed');
    if (i < step) el.classList.add('completed');
    if (i === step) el.classList.add('active');
  });
  document.getElementById('line-1-2').classList.toggle('done', step > 1);
  document.getElementById('line-2-3').classList.toggle('done', step > 2);
}

function showPanel(id) {
  document.querySelectorAll('.step-panel').forEach(function(p) { p.classList.remove('active'); });
  document.getElementById(id).classList.add('active');
}

// ── Phone preview ─────────────────────────────────────────────────────────────
document.getElementById('businessPhone').addEventListener('input', function(e) {
  var e164 = toE164(e.target.value);
  var el   = document.getElementById('phonePreview');
  if (e164) { el.textContent = 'Registered as: ' + e164; el.style.display = 'block'; }
  else { el.style.display = 'none'; }
});

// ── Navigation ────────────────────────────────────────────────────────────────
function goToStep1() { updateSteps(1); showPanel('panel-1'); }

function goToStep2() {
  var name  = document.getElementById('businessName').value.trim();
  var phone = document.getElementById('businessPhone').value.trim();
  var email = document.getElementById('email').value.trim();
  var valid = true;

  if (!name) {
    document.getElementById('businessName').classList.add('error');
    document.getElementById('err-name').classList.add('show');
    valid = false;
  } else {
    document.getElementById('businessName').classList.remove('error');
    document.getElementById('err-name').classList.remove('show');
  }

  var e164 = toE164(phone);
  if (!e164) {
    document.getElementById('businessPhone').classList.add('error');
    document.getElementById('err-phone').classList.add('show');
    valid = false;
  } else {
    document.getElementById('businessPhone').classList.remove('error');
    document.getElementById('err-phone').classList.remove('show');
  }

  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    document.getElementById('email').classList.add('error');
    document.getElementById('err-email').classList.add('show');
    valid = false;
  } else {
    document.getElementById('email').classList.remove('error');
    document.getElementById('err-email').classList.remove('show');
  }

  if (!valid) return;

  state.businessName  = name;
  state.businessPhone = e164;
  state.email         = email;
  updateSteps(2);
  showPanel('panel-2');
}

function goToStep3() {
  if (!state.stripeConnected) return;
  updateSteps(3);
  showPanel('panel-3');
}

// ── Stripe Connect ────────────────────────────────────────────────────────────
function connectStripe() {
  document.getElementById('stripeErrorBox').style.display = 'none';
  var stateData = btoa(JSON.stringify({
    businessName:  state.businessName,
    businessPhone: state.businessPhone,
    email:         state.email
  }));
  var params = new URLSearchParams({
    response_type: 'code',
    client_id:     CONFIG.STRIPE_CLIENT_ID,
    scope:         'read_write',
    state:         stateData,
    redirect_uri:  window.location.origin + window.location.pathname + '?stripe_callback=1'
  });
  window.location.href = 'https://connect.stripe.com/oauth/authorize?' + params.toString();
}

// ── OAuth callback ────────────────────────────────────────────────────────────
function checkStripeCallback() {
  var params     = new URLSearchParams(window.location.search);
  var code       = params.get('code');
  var stateParam = params.get('state');
  var error      = params.get('error');

  if (error) {
    window.history.replaceState({}, '', window.location.pathname);
    updateSteps(2); showPanel('panel-2');
    var box = document.getElementById('stripeErrorBox');
    box.textContent = 'Stripe connection cancelled. Please try again.';
    box.style.display = 'block';
    return;
  }

  if (!code) return;

  window.history.replaceState({}, '', window.location.pathname);

  try {
    var restored        = JSON.parse(atob(stateParam || ''));
    state.businessName  = restored.businessName  || '';
    state.businessPhone = restored.businessPhone || '';
    state.email         = restored.email         || '';
  } catch(e) {}

  updateSteps(2); showPanel('panel-2');

  fetch(CONFIG.BACKEND_URL + '?action=stripe-connect', {
    method:  'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      code:          code,
      businessName:  state.businessName,
      businessPhone: state.businessPhone,
      email:         state.email
    })
  })
  .then(function(r) {
    return r.text().then(function(text) {
      var data = safeParseJSON(text);
      if (!r.ok) throw new Error((data && data.error) ? data.error : text);
      return data;
    });
  })
  .then(function(data) {
    if (data && data.stripe_user_id) {
      state.stripeConnected = true;
      state.stripeAccountId = data.stripe_user_id;
      state.accessToken     = data.access_token;   // ← store for checkout
      document.getElementById('connectedBadge').classList.add('show');
      document.getElementById('stripeConnectBtn').style.display = 'none';
      document.getElementById('continueToPayBtn').disabled = false;
    } else {
      throw new Error('No stripe_user_id in response');
    }
  })
  .catch(function(err) {
    var box = document.getElementById('stripeErrorBox');
    box.textContent = 'Could not connect Stripe: ' + err.message;
    box.style.display = 'block';
  });
}

// ── Subscribe ─────────────────────────────────────────────────────────────────
function handleSubscribe() {
  var btn     = document.getElementById('subscribeBtn');
  var btnText = document.getElementById('subscribeBtnText');
  var spinner = document.getElementById('subscribeSpinner');
  var errBox  = document.getElementById('checkoutErrorBox');

  btn.disabled          = true;
  btnText.style.display = 'none';
  spinner.style.display = 'block';
  errBox.style.display  = 'none';

  fetch(CONFIG.BACKEND_URL + '?action=create-checkout', {
    method:  'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      priceId:         CONFIG.STRIPE_PRICE_ID,
      businessName:    state.businessName,
      businessPhone:   state.businessPhone,
      email:           state.email,
      stripeAccountId: state.stripeAccountId,
      accessToken:     state.accessToken,           // ← passed to metadata for webhook
      successUrl: window.location.origin + window.location.pathname + '?success=1&biz=' + encodeURIComponent(state.businessName),
      cancelUrl:  window.location.href
    })
  })
  .then(function(r) {
    return r.text().then(function(text) {
      var data = safeParseJSON(text);
      if (!r.ok) throw new Error((data && data.error) ? data.error : text);
      return data;
    });
  })
  .then(function(data) {
    if (data && data.url) {
      window.location.href = data.url;
    } else {
      throw new Error((data && data.error) ? data.error : 'No checkout URL returned');
    }
  })
  .catch(function(err) {
    btn.disabled          = false;
    btnText.style.display = 'block';
    spinner.style.display = 'none';
    errBox.textContent    = 'Error: ' + err.message;
    errBox.style.display  = 'block';
  });
}

// ── Success ───────────────────────────────────────────────────────────────────
function checkSuccessCallback() {
  var params = new URLSearchParams(window.location.search);
  if (params.get('success') === '1') {
    var bizName = decodeURIComponent(params.get('biz') || 'Your business');
    document.getElementById('successDesc').textContent =
      bizName + ' is now live on Tideline PAY. Text ' + CONFIG.TIDELINE_NUMBER + ' to send your first payment link.';
    document.getElementById('stepsIndicator').style.display = 'none';
    showPanel('panel-success');
    window.history.replaceState({}, '', window.location.pathname);
  }
}

// ── Init ──────────────────────────────────────────────────────────────────────
checkStripeCallback();
checkSuccessCallback();
</script>
</body>
</html>
